<!doctype html>
<head>
	<title>park your bike!</title>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<!-- bootstrap -->
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
	<!-- Optional theme -->
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">

	<!-- Latest compiled and minified JavaScript -->
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

	<!-- bootbox -->
	<script src="/static/js/bootbox.js"></script>
	<script src="/static/data/bounds.js"></script>
	<style>
	
	
		#map { width: auto; height: 590px; clear: left; }
		#comments { width: 230px; height: 600px }

		.container {
			width: 900px;
			height: auto;
			overflow: hidden;
		}
		.left {
		    float: none; /* not needed, just for clarification */
		    background: #e8f6fe;
		    /* the next props are meant to keep this block independent from the other floated one */
		    width: auto;
		    overflow: hidden;
		}​​
		.bb-code-small {
		    font-size:0.9em;
		}

		.bb-alert {
		    position:fixed;
		    top:0%;
            width: 100%;
		    left:0;
		    margin-bottom:0;
		    font-size:1.2em;
		    padding:1em 1.3em;
		    z-index:2000;
		}
		
		.bool {
    font-style: italic;
    color: #313131;
}

.testingStyles {font-size: 12px;
   width: 225px;
   line-height:50px;
    font-size: 15px;
   color:#fff;
   background: #333333;
   margin: 10px;
   border: 2px;
   padding: 10px;
   position: absolute;
   z-index:999;}
       optgroup[label="Metro Local Service"] {
        background: #000;
		color:#FFF;
           font-style:normal;
    }
	
	       optgroup[label="Metro Express Service"] {
        background: #005DAA;
               font-style:normal;
    }

		       optgroup[label="Metro Limited Stop Service"] {
                   font-style:normal;
    }
	
		       optgroup[label="Metro Rapid Service"] {
        background: #D11242;
                   font-style:normal;
    }

	
	#replyComments p {
    position:relative;
	padding: 10px 20px 20px 50px;
	background-color:#ccc;
}
#replyComments p:before {
    content: url(http://metro.net/interactives/thelab/community/user.png);
    position:absolute;
    left:0px; /* adjust it to your custom font needings */
	top:0px;
}

	
	</style>
</head>


	<body onLoad="load()">
		<div class="container">
			<h2>Help Build Bikeshare!</h2>
            <p>Metro is leading a regional effort to develop a user-friendly bikeshare system to facilitate first/last mile connections. The program will provide a fleet of bicycles that can be borrowed from strategically placed bikeshare stations. Metro’s Regional Bikeshare Implementation Plan will specify locations for these bikeshare stations in Phase I of the program. Your input can help Metro identify its Phase I bikeshare station site choices and help propose locations for future phases. <button onclick="moreInfo()">Click here for more info.</button> </p>
		    <div class="left">
		       <div id="map" style="width: 100%; height:500px; border: 1px solid; border-color:#999; background-color: #333;"></div>
		    </div>
             <select class="testingStyles" id="route">
             <option disabled="disabled" selected="selected">Select an Area</option>
      <option style="background:#ADB8BF" value="downtown">Downtown L.A.</option>
      <option style="background:#ADB8BF" value="longbeach">Long Beach</option>
      <option style="background:#ADB8BF" value="pasadena">Pasadena</option>
      <option style="background:#F15623" value="santamonica">Santa Monica</option>
      </optgroup>

    </select>		
		</div>
	    <div class="bb-alert alert alert-info" style="display:none;">
	        <span>The examples populate this alert with dummy content</span>
	    </div>
	</body>
</html>


<script>

function moreInfo(){
	
bootbox.alert("<h2>More Info</h2><p>Metro has proposed a number of initial launch stations (shown in orange). Let us know what you think of these locations by clicking ‘like’ or ‘comment.’</p><p> If you know of a location that would be a great spot for a bikeshare station, pin it on the map below (user suggestions show in purple). If someone has already suggested that location, you can tell us you like it or give more information by leaving a comment.</p><p> Currently, Metro is only seeking input on areas identified for Phase 1: Downtown LA, Pasadena, Santa Monica and Long Beach.</p><p> Final bikeshare station locations will be determined by Metro, City staff and the bikeshare operator. Locations will be determined by availability of space, right-of-way, ADA access and various other factors.  Implementation is currently planned for 2016.</p>", function() {
});	
}

//grab variable from URL (Called out by EV Station Page)
var initLAT = getUrlVars()["lat"];
var initLON = getUrlVars()["lon"];

//Getting URL Variable
function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
    vars[key] = value;
    });
    return vars;
}

var centerstart = new google.maps.LatLng(34.056946, -118.244081);
var markersArray = [];	
var userMarker = -1;
var stationinfoWindow = new google.maps.InfoWindow();

//Initial Map Setup
var map = new google.maps.Map(document.getElementById('map'), {
		  center: centerstart,
          zoom: 10,
		  minZoom: 5,
		  mapTypeId: google.maps.MapTypeId.ROADMAP,
		  streetViewControl: false,
		  mapTypeControl: false,
		  zoomControlOptions: {
			  style: google.maps.ZoomControlStyle.LARGE
			  }
		});

var circle = new google.maps.Circle({
            map: map,
            clickable: false,
            // metres
            radius: 90,
            fillColor: '#fff',
            fillOpacity: .6,
            strokeColor: '#313131',
            strokeOpacity: .4,
            strokeWeight: .8
 
  }), downtownPOLY = new google.maps.Polygon({
    paths: downtown,
	clickable: false,
	strokeColor: '#000',
	strokeOpacity: 0.2,
	strokeWeight: 1,
	fillColor: '#CC6600',
	fillOpacity: 0.3,
	zIndex: 50 

  }), pasadenaPOLY = new google.maps.Polygon({
    paths: pasadena,
	clickable: false,
	strokeColor: '#000',
	strokeOpacity: 0.2,
	strokeWeight: 1,
	fillColor: '#CC6600',
	fillOpacity: 0.3,
	zIndex: 50 

  }),  santamonicaPOLY = new google.maps.Polygon({
    paths: santamonica,
	clickable: false,
	strokeColor: '#000',
	strokeOpacity: 0.2,
	strokeWeight: 1,
	fillColor: '#CC6600',
	fillOpacity: 0.3,
	zIndex: 50 

  }), longbeachPOLY = new google.maps.Polygon({
    paths: longbeach,
	clickable: false,
	strokeColor: '#000',
	strokeOpacity: 0.2,
	strokeWeight: 1,
	fillColor: '#CC6600',
	fillOpacity: 0.3,
	zIndex: 50 

  }),universityPOLY = new google.maps.Polygon({
    paths: university,
	clickable: false,
	strokeColor: '#000',
	strokeOpacity: 0.2,
	strokeWeight: 1,
	fillColor: '#CC6600',
	fillOpacity: 0.3,
	zIndex: 50 

  }),longbeachextPOLY = new google.maps.Polygon({
    paths: longbeachext,
	clickable: false,
	strokeColor: '#000',
	strokeOpacity: 0.2,
	strokeWeight: 1,
	fillColor: '#CC6600',
	fillOpacity: 0.3,
	zIndex: 50 

  });


//Location Values
var myLatLng = new google.maps.LatLng(33.963572, -118.457177);
var downtownLatLng = new google.maps.LatLng(34.042145, -118.247164);
var santamonicaLatLng = new google.maps.LatLng(34.027127, -118.479434);
var pasadenaLatLng = new google.maps.LatLng(34.157202, -118.133697);
var longbeachLatLng = new google.maps.LatLng(33.774312, -118.193188);


//Location Select
var selectmenu=document.getElementById('route')
selectmenu.onchange=function(){
if (this.value == ''){
	}
	else{ 
	if (this.value == 'downtown'){
	map.panTo(downtownLatLng);
	map.setZoom(13);
	}
	else if (this.value == 'longbeach'){
	map.panTo(longbeachLatLng);
	map.setZoom(13);
	}
	else if (this.value == 'pasadena'){
	map.panTo(pasadenaLatLng);
	map.setZoom(13);
	}
	else if (this.value == 'santamonica'){
	map.panTo(santamonicaLatLng);
	map.setZoom(13);
	}
}}


addLike = function(rID, rLikes){
	  var addlike_url = "/api/comment/" + rID + "/";
	  var newlikes = rLikes + 1;
		  $.ajax(addlike_url, {
	 type: 'POST',
	 data: { likes: newlikes },

	 success:function(){
		 console.log("Like count updated!");
	stationinfoWindow.close(map,this);
					  Example.show("You Liked This Location!");
	     },
		 error:function(jqXhr, statusText, error){
			  console.log(statusText, error);}
	});

};


viewReply = function(rID){

$.getJSON("/api/comment/" + rID + "/", function(data) {
	var AllReplies = data.reply.toString();
	
//document.getElementById("replyComments").innerHTML = AllReplies;


addReply = function(rID){
	setTimeout(function(){
		
		var div = document.getElementById('modal-footer');
		div.innerHTML = div.innerHTML + "<br><div id='replyComments' style='text-align: left; margin-top: -5px;'><h3>Comments:</h3><div id='noComments' >No Comments</div>" +  AllReplies + "</div>";
			if (AllReplies != ''){
				document.getElementById('noComments').style.visibility = 'hidden';
	}else{
			document.getElementById('noComments').style.visibility = 'visible';	
	}
		},500)
				
	var msg = "Add a comment about this location:" ;
		bootbox.prompt(msg, function(result) {             
		  if (result === null) {   
		  } else {
			  
			  	if (result != ''){
  			var reply = AllReplies + "<p>" + result + "</p>";

var addreply_url = "/api/comment/" + rID + "/";
		    $.ajax(addreply_url, {
		      // type: 'GET',
			  type: 'POST',
			  data: { reply: reply },
			  success:function(){
				  console.log("Hooray, it worked!");
				  Example.show("Your Comment Has Been Added!");
            },
			error:function(jqXhr, statusText, error){
			  console.log(statusText, error);
			}
		    });
				}
				else{Example.show("No Comment Added...");
				  addReply(rID);}}
		});

};




});

};




//Initial Setup
function load() {
	
$.ajaxSetup({ cache: false });
	
//reset dropdown Options
document.getElementById('route').selectedIndex = 0;
//Place Location Selector within Google Maps DIV	
var homeControlDiv = document.createElement('DIV');
homeControlDiv = document.getElementById('route');
homeControlDiv.index = 1;
map.controls[google.maps.ControlPosition.TOP_RIGHT].push(homeControlDiv);



if (initLAT != null && initLON !=null){
	var newCenter = new google.maps.LatLng(initLAT, initLON);
	map.panTo(newCenter);
	map.setZoom(16);
}

//Setup Bike Layer	
var bikeLayer = new google.maps.BicyclingLayer();
bikeLayer.setMap(map);

//Set Boundary Locations
downtownPOLY.setMap(map);
pasadenaPOLY.setMap(map);
santamonicaPOLY.setMap(map);
longbeachPOLY.setMap(map);
longbeachextPOLY.setMap(map);
universityPOLY.setMap(map);

setMarkers();
//setBikeStations(map, bikeStations);	
	}
	

setMarkers = function(){
	
	
	
	
  
//Grab JSON data	
$.getJSON('/api/comment/', function(data) {
	//var count = data.length;
	var commentNumber = 0;
	//Grab data in Objects
	var userMarkers = data[Object.keys(data)[1]]
	
	
//Set Markers
$.each(userMarkers, function() {
	
//Check to see if comment is approved
	var mapproved = this.approved;
	var mcategory = this.category;
	if (mapproved == 1){
		if (mcategory == 'metroSelected'){
  var image = new google.maps.MarkerImage('http://metro.net/interactives/thelab/community/cycling.png',
  new google.maps.Size(32, 37),
  new google.maps.Point(0,0),
 new google.maps.Point(16, 37));
		}
		else {
			var image = new google.maps.MarkerImage('http://metro.net/interactives/thelab/community/bullet_purple.png',
  new google.maps.Size(16, 16),
  new google.maps.Point(0,0),
  new google.maps.Point(8, 8));
		}
	var mlat = this.lat;
	var mlon = this.lon;
	var myLatLng = new google.maps.LatLng(mlat, mlon);
	var marker = new google.maps.Marker({
	position: myLatLng,
	clickable: true,
	zIndex:888,
	 icon: image,
	map: map,
	mComment: this.comment,
	mLikes: this.likes,
	mID: this.id,
	mCategory: this.category
	});
	
google.maps.event.addListener(marker, 'click', function() {
	 var rCommentstrip = this.mComment
	 var rComment = rCommentstrip.replace(/(<([^>]+)>)/ig,"");;
	 var rLikes = this.mLikes;
	 var rCategory = this.mCategory;
	 var rID = this.mID;
	 viewReply(this.mID);
	 
	if (rCategory == 'userSelected'){
	 stationinfoWindow.setContent("<table width='450' border='0'><tr><td colspan='2' style='padding:5px 5px 5px 10px;' bgcolor='#000000'><div style='display:table;'><div style='display: table-cell; vertical-align: middle;'><img src='http://metro.net/interactives/thelab/community/comment_icon.png' /></div><div style='display: table-cell; color:#fff; font-size:30px; vertical-align: middle; padding-left: 18px;'>User Comment</div></div></td></tr><tr><td colspan='2' style='padding:5px;'><b>Comment: </b>" + rComment + "</td></tr><tr><td style='padding:5px;' align='left'><font color='#128fde'><b>" + rLikes + " user(s) have liked this location.</b></font></td><td style='padding:5px;' align='right'><a id='myLink' href='#' onclick='addLike("+ rID +", " + rLikes + ");return false;'><img style='padding-right: 5px;' src='http://metro.net/interactives/thelab/community/like.png' /></a><a id='myLink' href='#' onclick='addReply("+ rID +");return false;'><img src='http://metro.net/interactives/thelab/community/comment.png' /></a></td></tr></table>");}
	 else{
	 stationinfoWindow.setContent("<table width='450' border='0'><tr><td colspan='2' style='padding:5px 5px 5px 10px;' bgcolor='#000000'><div style='display:table;'><div style='display: table-cell; vertical-align: middle;'><img src='http://metro.net/interactives/thelab/community/cycling_cube.png' /></div><div style='display: table-cell; color:#fff; font-size:30px; vertical-align: middle; padding-left: 18px;'>" + rComment + "</div></div></td></tr><tr><td colspan='2' style='padding:5px;'><b>Comment: </b>This location has been proposed by the agency for a bikeshare station installation.</td></tr><tr><td style='padding:5px;' align='left'><font color='#128fde'><b>" + rLikes + " user(s) have liked this location.</b></font></td><td style='padding:5px;' align='right'><a id='myLink' href='#' onclick='addLike("+ rID +", " + rLikes + ");return false;'><img style='padding-right: 5px;' src='http://metro.net/interactives/thelab/community/like.png' /></a><a id='myLink' href='#' onclick='addReply("+ rID +");return false;'><img src='http://metro.net/interactives/thelab/community/comment.png' /></a></td></tr></table>");}
	 stationinfoWindow.open(map,marker);
	 marker2.setVisible(false);
	 circle.setVisible(false);
  });
	}});	
});


};

function setBikeStations(map, bikeStations) {
  var image = new google.maps.MarkerImage('http://metro.net/interactives/thelab/community/cycling.png',
  new google.maps.Size(32, 37),
  new google.maps.Point(0,0),
 new google.maps.Point(16, 37));
/* var shadow = new google.maps.MarkerImage('marker-panel.png',
new google.maps.Size(37, 32),
new google.maps.Point(0,0),
new google.maps.Point(0, 32));*/
for (var i = 0; i < bikeStations.length; i++) {

     var bikeStationsID = bikeStations[i];
	 var bLatLng = new google.maps.LatLng(bikeStationsID[0], bikeStationsID[1]);
     var bmarker = new google.maps.Marker({
          position: bLatLng,
          map: map,
		  //shadow: shadow,
		  icon: image,
		  zIndex:999,
          stationID: bikeStationsID[2],
		  stationLAT: bikeStationsID[0],
		  stationLON: bikeStationsID[1],
          });


google.maps.event.addListener(bmarker, 'click', function() { 
	var dataID = this.stationID;
	var dataLAT = this.stationLAT;
	var dataLON = this.stationLON;
	var dataLatLng = new google.maps.LatLng(dataLAT, dataLON);
	stationinfoWindow.setContent("<table width='450' border='0'><tr><td colspan='2' style='padding:5px;' bgcolor='#000000'><div style='display:table;'><div style='display: table-cell; vertical-align: middle;'><img src='http://metro.net/interactives/thelab/community/cycling_cube.png' /></div><div style='display: table-cell; color:#fff; font-size:30px; vertical-align: middle; padding-left: 18px;'>" + dataID + "</div></div></td></tr><tr><td colspan='2' style='padding:5px;'><b>Note: </b>This location was chosen by Metro. Location will be situated at the intersection of 7th/Flower by the Macy’s Plaza.</td></tr><tr><td style='padding:5px;' align='left'><font color='#128fde'><b>25 people have liked this location.</b></font></td><td style='padding:5px;' align='right'><img style='padding-right: 5px;' src='http://metro.net/interactives/thelab/community/like.png' /><img src='http://metro.net/interactives/thelab/community/comment.png' /></td></tr></table>");
	map.panTo(dataLatLng);
	stationinfoWindow.open(map,this);
		 marker2.setVisible(false);
	 circle.setVisible(false);
 });
		}
}  


withinBounds = function(event) {
	var locationCheck = google.maps.geometry.poly.containsLocation(event.latLng, downtownPOLY);
	var locationCheck2 = google.maps.geometry.poly.containsLocation(event.latLng, santamonicaPOLY);
	var locationCheck3 = google.maps.geometry.poly.containsLocation(event.latLng, pasadenaPOLY);
	var locationCheck4 = google.maps.geometry.poly.containsLocation(event.latLng, longbeachPOLY);
	var locationCheck5 = google.maps.geometry.poly.containsLocation(event.latLng, longbeachextPOLY);
	var locationCheck6 = google.maps.geometry.poly.containsLocation(event.latLng, universityPOLY);
	
	circle.bindTo('center', marker2, 'position');
	var bounds = circle.getBounds();
	//noteA.text(bounds.contains(myLatLng));	
	
	if (locationCheck || locationCheck2 || locationCheck3 || locationCheck4 || locationCheck5 || locationCheck6){
		if (locationCheck){
		//alert("DOWNTOWN");	
		}
		stationinfoWindow.setContent("<center><button onclick='addComment();'>Add a comment at this location.</button><br> You can drag me around too!</center>");
		}
		else{
		stationinfoWindow.setContent("Please select an area within the boundaries.");
		}
	stationinfoWindow.open(map,marker2);
	circle.setVisible(true);
}


//On Map Click
google.maps.event.addListener(map, "click", function(event) {
	
		 //Reset Captured Coordinates
		 markerLAT = event.latLng.lat();
		 markerLON = event.latLng.lng();
		 var stationSelect = new google.maps.LatLng(markerLAT, markerLON); 
		 //Center Map to Selected Location
		 map.panTo(stationSelect);	

	//If Marker Exists
	if ( userMarker > 0 ) {
		marker2.setVisible(true);
		marker2.setPosition(stationSelect);
	}
	//If Marker Does not Exist
	else {
		userMarker = 1;
		marker2 = new google.maps.Marker({
			map: map,
			clickable: false,
			draggable: true,
			position: stationSelect
			});
	}
			
withinBounds(event);

google.maps.event.addListener(marker2,'dragend',function(event) {
	stationinfoWindow.open(map,this);
	markerLAT = event.latLng.lat();
	markerLON = event.latLng.lng();
	withinBounds(event);
    });
	
google.maps.event.addListener(marker2,'dragstart',function(event) {
	stationinfoWindow.close(map,this);
    });
	
google.maps.event.addListener(stationinfoWindow,'closeclick',function(){
	circle.setVisible(false);
	marker2.setVisible(false);
	userMarker = -1;
	});
	
	


addComment = function(){
	var msg = "<h2>Add This Location</h2><form id='infos' action=''><br>\
    Name:<input type='text' name='name' id='name'></input><br/>\
    Email:<input type='text' name='email' id='email'></input><br>\
	Zip Code:<input type='text' id='zipCode'></input>\
    </form><br>Enter Your Comment Below:" ;
		bootbox.prompt(msg, function(result) {                
		  if (result === null) {   
		  } else {
  			var comment = result;
			if (comment != ''){
			var name = document.getElementById("name").value;
			var email = document.getElementById("email").value;
			var zipCode = document.getElementById("zipCode").value;
			// var addsite_url = '/siteadd/'+markerLAT+'/'+markerLON+'/'+comment;
			var addsite_url = '/api/comment/'
		    $.ajax(addsite_url, {
		      // type: 'GET',
			  type: 'POST',
			  data: { lat: markerLAT, lon: markerLON, comment: comment, name: name, email: email, zipcode: zipCode },
			  success:function(){
				  console.log("Hooray, it worked!");
				  Example.show("Thanks for your input! <b>"+comment+"</b>");
				 window.open("/?lat=" + markerLAT + "&lon=" + markerLON,"_self")
             //map.removeLayer(newMarker)
            },
			error:function(jqXhr, statusText, error){
			  console.log(statusText, error);
			}
		    });
		  }
		  		  else{Example.show("No Comment Added...");
				  addComment();}
		  }
		  
		});
	}
		
	});

	


</script>

<script src="/static/js/example.js"></script>
    <script>
        $(function() {
            Example.init({
                "selector": ".bb-alert"
            });
        });
    </script>
